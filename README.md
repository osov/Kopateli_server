# Документация по игровому серверу "Копатели"

## 1. Обзор проекта

Этот проект представляет собой авторитетный сервер для многопользовательской игры в реальном времени. Он отвечает за обработку подключений клиентов, управление игровым миром и синхронизацию состояния между игроками.

**Технологический стек:**
- **Среда выполнения:** [Bun](https://bun.sh/)
- **Язык:** TypeScript
- **Сетевое взаимодействие:** WebSocket
- **База данных:** MySQL (через `mysql2`)
- **Кэширование/Сессии:** Redis (через `redis`)

## 2. Структура проекта

Проект имеет модульную структуру для лучшей организации кода.

- `src/`: Основной исходный код приложения.
  - `main.ts`: Точка входа в приложение. Инициализирует и запускает сервер.
  - `server/`: Логика, связанная с управлением сервером.
    - `game_server.ts`: Основной файл сервера, управляет WebSocket, игровым циклом и аутентификацией.
    - `room_manager.ts`: Управляет игровыми локациями (комнатами) и переходами игроков между ними.
  - `rooms/`: Логика отдельных игровых комнат.
    - `game_room.ts`: Реализация конкретной игровой комнаты, управляет сущностями и обрабатывает игровую логику внутри локации.
  - `entitys/`: Определения игровых сущностей (например, `user.ts`).
  - `modules/`: Вспомогательные модули, например, менеджер для регистрации модулей.
  - `config/`: Файлы конфигурации (порты, параметры игры, сетевые сообщения).
  - `utils/`: Вспомогательные утилиты (например, `clients.ts` для управления списком клиентов).
- `data/`: Игровые данные.
  - `scene_data/`: Данные о сценах и локациях в формате `.scn` (JSON).

## 3. Ключевые концепции

### Жизненный цикл сервера

1.  **Запуск:** `bun src/main.ts`.
2.  `main.ts` импортирует конфигурацию, регистрирует модули и создает экземпляр `GameServer`.
3.  `GameServer` запускает WebSocket сервер для приема клиентов и `CommandServer` для административных команд.
4.  Запускается основной игровой цикл (`update` в `game_server.ts`), который с фиксированной частотой вызывает `update` у `RoomManager`.

### Подключение и аутентификация

1.  Клиент устанавливает WebSocket соединение.
2.  Клиент отправляет сообщение `CS_CONNECT` с хэшем для аутентификации.
3.  `GameServer` проверяет хэш, создает нового пользователя в БД (если необходимо) и связывает `id_user` с сокетом.
4.  После успешной аутентификации `RoomManager` отправляет клиенту начальные данные (`SC_INIT`) и помещает его в комнату по умолчанию.

### Управление комнатами

- `RoomManager` при старте загружает данные о всех локациях из `data/scene_data`.
- Для каждой локации создается экземпляр `GameRoom`.
- `RoomManager` обрабатывает запросы на переход между комнатами (`CS_REQUEST_INTERACT`).
- Когда игрок переходит в новую комнату, он удаляется из старой (`on_leave`) и добавляется в новую (`on_join`).

### Игровая логика

- Вся игровая логика инкапсулирована в `GameRoom`.
- `GameRoom` хранит состояние всех игроков и других сущностей в своей локации.
- Сообщения от клиента (например, `CS_INPUT_STICK` для движения) обрабатываются в `on_message`.
- Ввод игрока обновляет его состояние (объект `User`).
- Изменения состояния (`SC_STATE_CHANGE`) рассылаются всем игрокам в той же комнате для синхронизации.

## 4. Конфигурация

Основная конфигурация сервера находится в директории `src/config`.

- `server.ts`: Порты сервера, базовые настройки.
- `game.ts`: Игровые параметры (например, `GAME_CONFIG`).
- `net_messages.ts`: Определения сетевых сообщений между клиентом и сервером.

## 5. Запуск

1.  **Установите Bun:** Следуйте [официальной инструкции](https://bun.sh/docs/installation).
2.  **Установите зависимости:**
    ```bash
    bun install
    ```
3.  **Запуск сервера:**
    ```bash
    bun start
    ```
4.  **Запуск в режиме разработки (с автоматической перезагрузкой):**
    ```bash
    bun watch
    ```
